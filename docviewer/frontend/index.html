<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>문서 뷰어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background: #1f2937; color: #fff; padding: 12px 20px; }
    main { display: flex; flex-direction: row; height: calc(100vh - 60px); }
    .sidebar { width: 40%; min-width: 380px; border-right: 1px solid #ddd; overflow-y: auto; padding: 16px; box-sizing: border-box; }
    .viewer { flex: 1; height: 100%; }
    form { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    label { display: flex; flex-direction: column; font-size: 13px; color: #374151; }
    input, select, button { padding: 6px 8px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f3f4f6; text-align: left; }
    tbody tr:nth-child(even) { background: #f9fafb; }
    .actions button { margin-right: 4px; }
    .login-panel { display: flex; gap: 8px; margin-bottom: 12px; }
    .status { margin-top: 8px; color: #ef4444; min-height: 20px; }
    .disabled { background: #f3f4f6; }
    .pagination { display: flex; gap: 8px; margin-top: 12px; align-items: center; }
    iframe { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>
  <header>
    <h1>전자결재 문서 뷰어</h1>
  </header>
  <main>
    <section class="sidebar">
      <div class="login-panel">
        <input type="text" id="username" placeholder="아이디" />
        <input type="password" id="password" placeholder="비밀번호" />
        <button id="loginBtn">로그인</button>
      </div>
      <div class="status" id="status"></div>
      <form id="filterForm">
        <label>제목
          <select id="titleFilter">
            <option value="">전체</option>
          </select>
        </label>
        <label>사용자
          <input type="text" id="userFilter" placeholder="사용자" />
        </label>
        <label>일자
          <input type="date" id="dateFilter" />
        </label>
        <label>월
          <input type="month" id="monthFilter" />
        </label>
        <label>검색어
          <input type="text" id="keywordFilter" placeholder="파일명/문서번호" />
        </label>
        <label>페이지 크기
          <input type="number" id="sizeFilter" value="50" min="1" max="200" />
        </label>
        <button type="submit">조회</button>
      </form>
      <table>
        <thead>
          <tr>
            <th>파일명</th>
            <th>문서번호</th>
            <th>소유자</th>
            <th>날짜</th>
            <th>액션</th>
          </tr>
        </thead>
        <tbody id="docsBody"></tbody>
      </table>
      <div class="pagination">
        <button id="prevPage">이전</button>
        <span id="pageInfo">0 / 0</span>
        <button id="nextPage">다음</button>
      </div>
    </section>
    <section class="viewer">
      <iframe id="pdfViewer" src=""></iframe>
    </section>
  </main>
  <script>
    const state = {
      token: localStorage.getItem('docviewer_token') || '',
      role: 'user',
      page: 1,
      totalPages: 0,
      currentBlobUrl: null,
    };

    function decodeToken(token) {
      try {
        const payload = token.split('.')[1];
        const padded = payload.replace(/-/g, '+').replace(/_/g, '/');
        const decoded = atob(padded + '='.repeat((4 - padded.length % 4) % 4));
        return JSON.parse(decoded);
      } catch (err) {
        return null;
      }
    }

    function setToken(token) {
      state.token = token;
      localStorage.setItem('docviewer_token', token);
      const payload = decodeToken(token);
      if (payload && payload.role) {
        state.role = payload.role;
      }
      applyRole();
    }

    function applyRole() {
      const userInput = document.getElementById('userFilter');
      const payload = payloadFromToken();
      if (state.role === 'admin') {
        userInput.removeAttribute('readonly');
        userInput.classList.remove('disabled');
      } else {
        userInput.value = payload.sub || '';
        userInput.setAttribute('readonly', 'readonly');
        userInput.classList.add('disabled');
      }
    }

    function payloadFromToken() {
      return decodeToken(state.token) || {};
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) {
        setStatus('아이디와 비밀번호를 입력하세요.');
        return;
      }
      const body = new URLSearchParams();
      body.append('username', username);
      body.append('password', password);
      try {
        const res = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
        });
        if (!res.ok) {
          throw new Error('로그인 실패');
        }
        const data = await res.json();
        setToken(data.access_token);
        setStatus('로그인 성공');
        await loadTitles();
        state.page = 1;
        await fetchDocs();
      } catch (err) {
        setStatus('로그인 실패: ' + err.message);
      }
    }

    function setStatus(message) {
      document.getElementById('status').textContent = message || '';
    }

    function getAuthHeaders() {
      if (!state.token) return {};
      return { Authorization: 'Bearer ' + state.token };
    }

    async function loadTitles() {
      if (!state.token) return;
      try {
        const res = await fetch('/api/titles', { headers: getAuthHeaders() });
        if (!res.ok) throw new Error('제목 조회 실패');
        const data = await res.json();
        const select = document.getElementById('titleFilter');
        select.innerHTML = '<option value="">전체</option>';
        data.titles.forEach(title => {
          const option = document.createElement('option');
          option.value = title;
          option.textContent = title;
          select.appendChild(option);
        });
      } catch (err) {
        console.error(err);
        setStatus('제목 목록을 불러오지 못했습니다.');
      }
    }

    function buildQueryParams() {
      const params = new URLSearchParams();
      const title = document.getElementById('titleFilter').value;
      const user = document.getElementById('userFilter').value.trim();
      const date = document.getElementById('dateFilter').value;
      const month = document.getElementById('monthFilter').value;
      const keyword = document.getElementById('keywordFilter').value.trim();
      const size = document.getElementById('sizeFilter').value || '50';

      if (title) {
        params.append('title', title);
      }
      if (keyword && !title) {
        params.append('q', keyword);
      }
      if (month) {
        params.append('type', 'month');
        params.append('ym', month);
      } else if (date) {
        params.append('type', 'day');
        params.append('date', date);
      } else {
        params.append('type', 'all');
      }
      if (user && state.role === 'admin') {
        params.append('user', user);
      }
      params.append('page', state.page.toString());
      params.append('size', size);
      return params;
    }

    async function fetchDocs() {
      if (!state.token) {
        setStatus('로그인이 필요합니다.');
        return;
      }
      try {
        const params = buildQueryParams();
        const res = await fetch('/api/docs?' + params.toString(), { headers: getAuthHeaders() });
        if (!res.ok) throw new Error('문서 목록 조회 실패');
        const data = await res.json();
        renderDocs(data.items || []);
        state.totalPages = Math.ceil(data.total / data.size) || 0;
        document.getElementById('pageInfo').textContent = `${state.page} / ${state.totalPages}`;
        setStatus('');
      } catch (err) {
        setStatus(err.message);
      }
    }

    function renderDocs(docs) {
      const tbody = document.getElementById('docsBody');
      tbody.innerHTML = '';
      docs.forEach(doc => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doc.file_name}</td>
          <td>${doc.doc_no || ''}</td>
          <td>${doc.owner_user || ''}</td>
          <td>${doc.created_date}</td>
          <td class="actions">
            <button data-action="preview" data-id="${doc.id}">미리보기</button>
            <button data-action="download" data-id="${doc.id}">다운로드</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function previewDoc(id) {
      if (!state.token) return;
      try {
        const res = await fetch(`/api/docs/${id}/preview`, { headers: getAuthHeaders() });
        if (!res.ok) throw new Error('미리보기 실패');
        const blob = await res.blob();
        if (state.currentBlobUrl) {
          URL.revokeObjectURL(state.currentBlobUrl);
        }
        const blobUrl = URL.createObjectURL(blob);
        state.currentBlobUrl = blobUrl;
        document.getElementById('pdfViewer').src = `/frontend/pdfjs/web/viewer.html?file=${encodeURIComponent(blobUrl)}`;
      } catch (err) {
        setStatus(err.message);
      }
    }

    async function downloadDoc(id) {
      if (!state.token) return;
      try {
        const res = await fetch(`/api/docs/${id}/download`, { headers: getAuthHeaders() });
        if (!res.ok) throw new Error('다운로드 실패');
        const blob = await res.blob();
        const disposition = res.headers.get('Content-Disposition') || '';
        const match = disposition.match(/filename="?([^";]+)"?/);
        const filename = match ? decodeURIComponent(match[1]) : `document-${id}.pdf`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        setStatus(err.message);
      }
    }

    document.getElementById('loginBtn').addEventListener('click', e => {
      e.preventDefault();
      login();
    });

    document.getElementById('filterForm').addEventListener('submit', async e => {
      e.preventDefault();
      state.page = 1;
      await fetchDocs();
    });

    document.getElementById('docsBody').addEventListener('click', async e => {
      const target = e.target;
      if (target.tagName !== 'BUTTON') return;
      const id = target.getAttribute('data-id');
      const action = target.getAttribute('data-action');
      if (action === 'preview') {
        await previewDoc(id);
      } else if (action === 'download') {
        await downloadDoc(id);
      }
    });

    document.getElementById('prevPage').addEventListener('click', async () => {
      if (state.page > 1) {
        state.page -= 1;
        await fetchDocs();
      }
    });

    document.getElementById('nextPage').addEventListener('click', async () => {
      if (state.totalPages && state.page < state.totalPages) {
        state.page += 1;
        await fetchDocs();
      }
    });

    if (state.token) {
      const payload = decodeToken(state.token);
      if (payload && payload.exp * 1000 > Date.now()) {
        state.role = payload.role || 'user';
        const userInput = document.getElementById('userFilter');
        userInput.value = payload.sub || '';
        applyRole();
        loadTitles().then(fetchDocs);
      } else {
        state.token = '';
        localStorage.removeItem('docviewer_token');
      }
    }
  </script>
</body>
</html>
